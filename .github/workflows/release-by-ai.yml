name: Release by AI

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Release version (e.g., v1.2.3). Leave empty to auto-detect from release-dry-run."
        required: false
        default: ""
      model:
        description: "OpenRouter model to use"
        required: false
        default: "openrouter/z-ai/glm-5"
        type: choice
        options:
          - "openrouter/z-ai/glm-5"
          - "openrouter/openai/gpt-5.2-codex"
          - "openrouter/moonshotai/kimi-k2.5"

jobs:
  release:
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    timeout-minutes: 60
    permissions:
      id-token: write
      contents: write
      pull-requests: write
      issues: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5.0.1
        with:
          fetch-depth: 0

      - name: Configure git
        run: |
          git config user.name dyoshikawa
          git config user.email dyoshikawa1993@gmail.com

      - name: Setup mise
        uses: jdx/mise-action@6d1e696aa24c1aa1bcc1adea0212707c71ab78a8 # v3.6.1
        with:
          experimental: true

      - name: Install dependencies
        run: pnpm install

      - name: Run OpenCode to perform release
        uses: anomalyco/opencode/github@4d187af9d20b04e4fbd77ad04eaaea241b8e25bf # v1.1.2
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          RELEASE_VERSION: ${{ inputs.version }}
        with:
          model: ${{ inputs.model }}
          use_github_token: "true"
          share: false
          prompt: |
            You are performing an automated release for this project on the main branch.

            Read the environment variable RELEASE_VERSION to check if a specific version was provided.

            Follow these steps:

            ## Step 0: Switch to the main branch

            The OpenCode GitHub Action automatically creates a temporary branch.
            You MUST switch back to the main branch before proceeding:
            Run `git checkout main` to switch to the main branch.

            ## Step 1: Determine the release version

            If RELEASE_VERSION is empty or not set:
            1. Execute the /release-dry-run command to analyze changes since the last release.
            2. Based on the dry run output, determine the appropriate next version following semantic versioning.
            3. Assign the determined version to use in the next step.

            If RELEASE_VERSION is set (e.g., "v1.2.3"):
            1. Use that version directly.

            ## Step 2: Execute the release

            Execute the /release command with the determined version as the argument.
            For example, if the version is "v1.2.3", run: /release v1.2.3

            IMPORTANT:
            - You MUST be on the main branch before executing /release. Use `git checkout main` if needed.
            - Follow the release command instructions exactly.
            - Do not skip any steps in the release process.
            - Wait for the publish-assets workflow to complete before publishing the release.
