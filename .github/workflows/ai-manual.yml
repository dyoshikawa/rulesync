name: AI Manual Task

on:
  workflow_dispatch:
    inputs:
      prompt:
        description: "The task prompt for AI"
        required: true
        type: string

jobs:
  ai-task:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    permissions:
      id-token: write
      contents: write
      pull-requests: write
      issues: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5.0.1
        with:
          fetch-depth: 0

      - name: Configure git
        run: |
          git config user.name dyoshikawa
          git config user.email dyoshikawa1993@gmail.com

      - name: Setup mise
        uses: jdx/mise-action@6d1e696aa24c1aa1bcc1adea0212707c71ab78a8 # v3.6.1
        with:
          experimental: true

      - name: Install dependencies
        run: pnpm install

      - name: Determine model based on prompt
        id: select-model
        shell: bash
        env:
          PROMPT: ${{ inputs.prompt }}
        run: |
          if [[ "$PROMPT" == *"glm"* ]]; then
            echo "model=openrouter/z-ai/glm-4.7" >> $GITHUB_OUTPUT
          elif [[ "$PROMPT" == *"kimi"* ]]; then
            echo "model=openrouter/moonshotai/kimi-k2.5" >> $GITHUB_OUTPUT
          else
            echo "model=openrouter/moonshotai/kimi-k2" >> $GITHUB_OUTPUT
          fi

      - name: Run OpenCode for manual task
        uses: anomalyco/opencode/github@4d187af9d20b04e4fbd77ad04eaaea241b8e25bf # v1.1.2
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          IS_UPSTREAM: ${{ github.repository == 'dyoshikawa/rulesync' }}
        with:
          model: ${{ steps.select-model.outputs.model }}
          use_github_token: "true"
          prompt: ${{ inputs.prompt }}
