name: AI Code Review

on:
  issue_comment:
    types: [created]

jobs:
  code-review:
    if: >-
      github.event.issue.pull_request &&
      contains(github.event.comment.body, '[review]') &&
      (
        github.event.comment.author_association == 'OWNER' ||
        github.event.comment.author_association == 'MEMBER' ||
        github.event.comment.author_association == 'COLLABORATOR'
      )
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      id-token: write
      contents: read
      pull-requests: read
      issues: read
    steps:
      - name: Checkout repository
        # actions/checkout@v6 is not compatible with anomalyco/opencode@v1.1.2
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 1

      - name: Setup mise
        uses: jdx/mise-action@c53b9236f0b3370f31520f8b142f141256d839c6 # v3.6.0
        with:
          experimental: true

      - name: Install dependencies
        run: pnpm install --ignore-scripts

      - name: Generate AI files
        run: pnpm run dev generate

      - name: Run OpenCode Review
        uses: anomalyco/opencode/github@4d187af9d20b04e4fbd77ad04eaaea241b8e25bf # v1.1.2
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
        with:
          model: openrouter/z-ai/glm-4.7
          prompt: |
            Run the /review-pr command to review this pull request.
